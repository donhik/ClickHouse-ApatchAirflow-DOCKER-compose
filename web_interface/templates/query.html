{% extends "base.html" %}

{% block title %}SQL –ó–∞–ø—Ä–æ—Å—ã{% endblock %}

{% block content %}
<div class="dashboard">
    <h2>üîç SQL –ó–∞–ø—Ä–æ—Å—ã –∫ ClickHouse</h2>
    
    <div class="query-section">
        <h3>–í—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π SQL-–∑–∞–ø—Ä–æ—Å</h3>
        
        <div class="query-editor">
            <textarea id="sql-query" rows="8" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à SQL-–∑–∞–ø—Ä–æ—Å –∫ ClickHouse...&#10;&#10;–ü—Ä–∏–º–µ—Ä:&#10;SELECT employer, COUNT(*) as cnt&#10;FROM hh_data.vacancies_enhanced&#10;GROUP BY employer&#10;ORDER BY cnt DESC&#10;LIMIT 10">{{ query if query else '' }}</textarea>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn-primary" onclick="executeQuery()">‚ñ∂Ô∏è –í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
                <button class="btn-secondary" onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </div>
        
        <div id="query-result" class="query-result" style="margin-top: 20px; display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
                <span id="row-count" style="color: #667eea; font-weight: bold;"></span>
            </div>
            <div id="result-content"></div>
        </div>
        
        <div class="query-examples" style="margin-top: 30px;">
            <h4>üìå –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:</h4>
            
            <div class="example-query">
                <h5>–¢–æ–ø-10 –∫–æ–º–ø–∞–Ω–∏–π –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≤–∞–∫–∞–Ω—Å–∏–π:</h5>
                <code>SELECT employer, COUNT(*) as cnt FROM hh_data.vacancies_enhanced GROUP BY employer ORDER BY cnt DESC LIMIT 10</code>
                <button class="btn-secondary" onclick="loadExample(this)">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            
            <div class="example-query">
                <h5>–°—Ä–µ–¥–Ω—è—è –∑–∞—Ä–ø–ª–∞—Ç–∞ –ø–æ –≥–æ—Ä–æ–¥–∞–º:</h5>
                <code>SELECT 
                        CASE 
                            WHEN TRIM(city) IN ('Moscow', '–ú–æ—Å–∫–≤–∞') THEN '–ú–æ—Å–∫–≤–∞'
                            WHEN TRIM(city) IN ('Krasnodar', '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä') THEN '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä'
                            WHEN TRIM(city) IN ('Volgograd', '–í–æ–ª–≥–æ–≥—Ä–∞–¥') THEN '–í–æ–ª–≥–æ–≥—Ä–∞–¥'
                            ELSE TRIM(city)
                        END AS city,
                        COUNT(*) AS vacancy_count,
                        ROUND(AVG(
                            (COALESCE(salary_from, 0) + COALESCE(salary_to, 0)) / 2
                        )) AS avg_salary
                    FROM hh_data.vacancies_enhanced 
                    WHERE 
                        TRIM(city) IN ('Moscow', '–ú–æ—Å–∫–≤–∞', 'Krasnodar', '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä', 'Volgograd', '–í–æ–ª–≥–æ–≥—Ä–∞–¥')
                    GROUP BY city
                    ORDER BY avg_salary DESC</code>
                <button class="btn-secondary" onclick="loadExample(this)">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            
            <div class="example-query">
                <h5>–í–∞–∫–∞–Ω—Å–∏–∏ —Å —É–¥–∞–ª—ë–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–æ–π:</h5>
                <code>SELECT name, employer, schedule FROM hh_data.vacancies_enhanced WHERE schedule = '–£–¥–∞–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞' LIMIT 20</code>
                <button class="btn-secondary" onclick="loadExample(this)">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            
            <div class="example-query">
                <h5>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –æ–ø—ã—Ç—É —Ä–∞–±–æ—Ç—ã:</h5>
                <code>SELECT experience, COUNT(*) as count FROM hh_data.vacancies_enhanced WHERE experience != '' AND experience IS NOT NULL GROUP BY experience ORDER BY count DESC</code>
                <button class="btn-secondary" onclick="loadExample(this)">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            
            <div class="example-query">
                <h5>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞–∫–∞–Ω—Å–∏–π –ø–æ —Ç–∏–ø—É –∑–∞–Ω—è—Ç–æ—Å—Ç–∏:</h5>
                <code>SELECT employment, COUNT(*) as count FROM hh_data.vacancies_enhanced WHERE employment != '' AND employment IS NOT NULL GROUP BY employment ORDER BY count DESC</code>
                <button class="btn-secondary" onclick="loadExample(this)">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            
            <div class="example-query">
                <h5>–í—Å–µ –≤–∞–∫–∞–Ω—Å–∏–∏ —Å –∑–∞—Ä–ø–ª–∞—Ç–æ–π –≤—ã—à–µ 200000 ‚ÇΩ:</h5>
                <code>SELECT name, employer, city, salary_from, salary_to FROM hh_data.vacancies_enhanced WHERE salary_from > 200000 OR salary_to > 200000 ORDER BY salary_from DESC LIMIT 20</code>
                <button class="btn-secondary" onclick="loadExample(this)">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>
    
    <div class="quick-actions" style="margin-top: 30px;">
        <a href="{{ url_for('index') }}" class="btn-primary">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <a href="{{ url_for('analytics') }}" class="btn-secondary">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function executeQuery() {
    const query = document.getElementById('sql-query').value.trim();
    
    if (!query) {
        alert('–í–≤–µ–¥–∏—Ç–µ SQL-–∑–∞–ø—Ä–æ—Å!');
        return;
    }
    
    const resultDiv = document.getElementById('query-result');
    const resultContent = document.getElementById('result-content');
    const rowCount = document.getElementById('row-count');
    
    resultDiv.style.display = 'block';
    resultContent.innerHTML = '<p style="color: #667eea;">‚è≥ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞...</p>';
    rowCount.textContent = '';
    
    // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ fetch
    fetch('/execute_query', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ query: query })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—Ü—ã
            if (data.rows && data.rows.length > 0) {
                let tableHTML = `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: white;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    ${data.columns.map(col => `<th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">${escapeHtml(col)}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.rows.forEach((row, rowIndex) => {
                    const rowStyle = rowIndex % 2 === 0 ? 'background: #f8f9fa;' : '';
                    tableHTML += `<tr style="${rowStyle}">`;
                    data.columns.forEach(col => {
                        let cellValue = row[col];
                        if (cellValue === null || cellValue === undefined) {
                            cellValue = 'NULL';
                        } else if (typeof cellValue === 'object') {
                            cellValue = JSON.stringify(cellValue);
                        }
                        tableHTML += `<td style="padding: 10px; border: 1px solid #dee2e6;">${escapeHtml(String(cellValue))}</td>`;
                    });
                    tableHTML += `</tr>`;
                });
                
                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                resultContent.innerHTML = tableHTML;
                rowCount.textContent = `${data.row_count} —Å—Ç—Ä–æ–∫`;
            } else {
                resultContent.innerHTML = '<p style="color: #777; padding: 20px; background: #f8f9fa; border-radius: 8px;">–ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ, –Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—É—Å—Ç–æ–π.</p>';
                rowCount.textContent = '0 —Å—Ç—Ä–æ–∫';
            }
        } else {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
            resultContent.innerHTML = `
                <div style="background: #fa709a; color: white; padding: 20px; border-radius: 8px;">
                    <strong>‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞:</strong><br>
                    ${escapeHtml(data.error)}
                    ${data.error_details ? '<br><br><details><summary>–ü–æ–¥—Ä–æ–±–Ω–µ–µ</summary><pre style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; overflow-x: auto; max-height: 200px;">' + escapeHtml(data.error_details) + '</pre></details>' : ''}
                </div>
            `;
        }
    })
    .catch(error => {
        resultContent.innerHTML = `
            <div style="background: #fa709a; color: white; padding: 20px; border-radius: 8px;">
                <strong>‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</strong> ${error.message}
            </div>
        `;
    });
}

function clearResults() {
    document.getElementById('query-result').style.display = 'none';
    document.getElementById('sql-query').value = '';
}

function loadExample(btn) {
    const code = btn.previousElementSibling.textContent;
    document.getElementById('sql-query').value = code;
}

function escapeHtml(text) {
    if (typeof text !== 'string') {
        return text;
    }
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}
</script>

<style>
.query-editor {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    border: 2px solid #e9ecef;
}

.query-editor textarea {
    width: 100%;
    padding: 15px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    resize: vertical;
    transition: border-color 0.3s;
    background: #2d2d2d;
    color: #f8f8f2;
}

.query-editor textarea:focus {
    outline: none;
    border-color: #667eea;
}

.query-result {
    background: white;
    padding: 20px;
    border-radius: 10px;
    border: 2px solid #dee2e6;
}

.example-query {
    background: #f8f9fa;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 8px;
    border-left: 4px solid #667eea;
}

.example-query h5 {
    margin-top: 0;
    margin-bottom: 8px;
    color: #495057;
    font-size: 1.1rem;
}

.example-query code {
    display: block;
    background: #2d2d2d;
    color: #f8f8f2;
    padding: 12px;
    border-radius: 5px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    margin-bottom: 10px;
    overflow-x: auto;
}

.example-query button {
    padding: 8px 16px;
    font-size: 14px;
}

table {
    font-size: 14px;
}

table th {
    font-weight: bold;
    white-space: nowrap;
}

table td {
    word-break: break-word;
}
</style>
{% endblock %}