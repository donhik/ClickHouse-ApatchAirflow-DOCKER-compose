{% extends "base.html" %}

{% block title %}SQL –ó–∞–ø—Ä–æ—Å—ã{% endblock %}

{% block content %}
<div class="dashboard">
    <h2>üîç SQL –ó–∞–ø—Ä–æ—Å—ã –∫ ClickHouse</h2>
    
    <div class="query-section">
        <h3>–í—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π SQL-–∑–∞–ø—Ä–æ—Å</h3>
        
        <div class="query-editor">
            <textarea id="sql-query" rows="8" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à SQL-–∑–∞–ø—Ä–æ—Å –∫ ClickHouse...&#10;&#10;–ü—Ä–∏–º–µ—Ä:&#10;SELECT employer_name, COUNT(*) as cnt&#10;FROM vacancies_simple&#10;GROUP BY employer_name&#10;ORDER BY cnt DESC&#10;LIMIT 10">{{ query if query else '' }}</textarea>
            <button class="btn-primary" onclick="executeQuery()" style="margin-top: 15px;">‚ñ∂Ô∏è –í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
        </div>
        
        <div id="query-result" class="query-result" style="margin-top: 20px; display: none;">
            <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
            <div id="result-content"></div>
        </div>
        
        <div class="query-examples" style="margin-top: 30px;">
            <h4>üìå –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:</h4>
            
            <div class="example-query">
                <h5>–¢–æ–ø-10 –∫–æ–º–ø–∞–Ω–∏–π –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≤–∞–∫–∞–Ω—Å–∏–π:</h5>
                <code>SELECT employer_name, COUNT(*) as cnt FROM vacancies_simple GROUP BY employer_name ORDER BY cnt DESC LIMIT 10</code>
                <button class="btn-secondary" onclick="loadExample(this)">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            
            <div class="example-query">
                <h5>–°—Ä–µ–¥–Ω—è—è –∑–∞—Ä–ø–ª–∞—Ç–∞ –ø–æ –≥–æ—Ä–æ–¥–∞–º:</h5>
                <code>SELECT area_name, ROUND(AVG((salary_from + salary_to) / 2)) as avg_salary FROM vacancies_simple WHERE salary_from > 0 AND salary_to > 0 AND salary_currency = 'RUR' GROUP BY area_name ORDER BY avg_salary DESC LIMIT 10</code>
                <button class="btn-secondary" onclick="loadExample(this)">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            
            <div class="example-query">
                <h5>–í–∞–∫–∞–Ω—Å–∏–∏ —Å —É–¥–∞–ª—ë–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–æ–π:</h5>
                <code>SELECT name, employer_name, schedule FROM vacancies_simple WHERE schedule = '–£–¥–∞–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞' LIMIT 20</code>
                <button class="btn-secondary" onclick="loadExample(this)">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            
            <div class="example-query">
                <h5>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –æ–ø—ã—Ç—É —Ä–∞–±–æ—Ç—ã:</h5>
                <code>SELECT experience, COUNT(*) as count FROM vacancies_simple WHERE experience != '' GROUP BY experience ORDER BY count DESC</code>
                <button class="btn-secondary" onclick="loadExample(this)">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>
    
    <div class="quick-actions" style="margin-top: 30px;">
        <a href="{{ url_for('index') }}" class="btn-primary">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <a href="{{ url_for('analytics') }}" class="btn-secondary">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function executeQuery() {
    const query = document.getElementById('sql-query').value.trim();
    
    if (!query) {
        alert('–í–≤–µ–¥–∏—Ç–µ SQL-–∑–∞–ø—Ä–æ—Å!');
        return;
    }
    
    const resultDiv = document.getElementById('query-result');
    const resultContent = document.getElementById('result-content');
    
    resultDiv.style.display = 'block';
    resultContent.innerHTML = '<p style="color: #667eea;">‚è≥ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞...</p>';
    
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å AJAX-–∑–∞–ø—Ä–æ—Å –∫ –±—ç–∫–µ–Ω–¥—É
    // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å
    setTimeout(() => {
        resultContent.innerHTML = `
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea;">
                <p><strong>–ó–∞–ø—Ä–æ—Å:</strong></p>
                <pre style="background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto;">${escapeHtml(query)}</pre>
                <p style="margin-top: 15px; color: #777;">–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API-—ç–Ω–¥–ø–æ–∏–Ω—Ç –≤ app.py</p>
            </div>
        `;
    }, 500);
}

function loadExample(btn) {
    const code = btn.previousElementSibling.textContent;
    document.getElementById('sql-query').value = code;
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}
</script>

<style>
.query-editor {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    border: 2px solid #e9ecef;
}

.query-editor textarea {
    width: 100%;
    padding: 15px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    resize: vertical;
    transition: border-color 0.3s;
}

.query-editor textarea:focus {
    outline: none;
    border-color: #667eea;
}

.query-result {
    background: white;
    padding: 20px;
    border-radius: 10px;
    border: 2px solid #dee2e6;
}

.example-query {
    background: #f8f9fa;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 8px;
    border-left: 4px solid #667eea;
}

.example-query h5 {
    margin-top: 0;
    margin-bottom: 8px;
    color: #495057;
}

.example-query code {
    display: block;
    background: #2d2d2d;
    color: #f8f8f2;
    padding: 12px;
    border-radius: 5px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    margin-bottom: 10px;
    overflow-x: auto;
}

.example-query button {
    padding: 8px 16px;
    font-size: 14px;
}
</style>
{% endblock %}